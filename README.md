# Spring Boot JPA Online shop example 

## ëª¨ë¸ë§ 
![](https://user-images.githubusercontent.com/28615416/80606188-f9311300-8a6e-11ea-8bd0-5978c60d9128.png)
![](https://user-images.githubusercontent.com/28615416/80606200-fd5d3080-8a6e-11ea-938c-db9ca1084f3f.png)


## ì—°ê´€ê´€ê³„ 1:N 
- ì–‘ë°©í–¥ ì—°ê´€ê´€ê³„ì—ì„œ, ê°ì²´ê°€ ì„œë¡œ ì°¸ì¡°í•˜ê³  ìˆëŠ”ë° ë„ëŒ€ì²´ ì£¼ì¸?ì€ ëˆ„êµ¬ë¡œ í• ê±°ì•¼? ì—ì„œ ë‚˜ì˜¨ ê°œë… 
- ë³´í†µ DBì—ì„œëŠ” ì™¸ë˜í‚¤ëŠ” 1:Nì—ì„œ Nìª½ì— ì¡´ì¬í•œë‹¤. ìƒê°í•´ë³´ë©´ ë‹¹ì—°í•œê±°
- Member(1) : Order(N)

```java
public class Member {

    @Id @GeneratedValue
    @Column(name = "member_id")
    private Long id;
    
    @OneToMany(mappedBy = "member")
    private List<Order> orders = new ArrayList();
} 

public class Order {
    
    @ManyToOne
    @JoinColumn(name = "member_id")
    private Member member;

}
```
- ì™¸ë˜í‚¤ëŠ” Order í…Œì´ë¸”ì— ì¡´ì¬í•˜ê³ (Nìª½ì— ì¡´ì¬í•¨), join ì»¬ëŸ¼ì€ `member_id` ì´ë‹¤. 
- mappedByëŠ” memberë¼ëŠ” í•„ë“œì— ì˜í•´ì„œ ë§¤í•‘ëœ ì •ë³´ì¼ ë¿, ì—°ê´€ê´€ê³„ ì£¼ì¸ì€ Orderì— ìˆê³ , Memberê°€ fkë¥¼ ë³€ê²½í•  ìˆ˜ ì—†ë‹¤. ì˜¤ì§ MemberëŠ” ì½ê¸° ì „ìš©ì´ë‹¤.


## ì—°ê´€ê´€ê³„ ê³„ì¸µêµ¬ì¡°
```java
public class Category {
    
    @Id @GeneratedValue
    @Column(name = "category_id")
    private Long id;
    
    @ManyToOne
    @JoinColumn(name="parent_id")
    private Category parent;

    @OneToMany(mappedBy = "parent")
    private List<Category> child = new ArrayList();

}
```
- ìê¸°ìì‹ ì„ ê³„ì¸µêµ¬ì¡°ë¡œ ê°€ì§ˆ ê²½ìš°, ë¶€ëª¨ëŠ” ManyToOneìœ¼ë¡œ ìì‹ì€ OneToManyë¡œ ë§¤í•‘í•œë‹¤.


## ì™¸ë˜í‚¤ëŠ” ê¼­ ê±¸ì–´ì•¼ í•˜ë‚˜? 
- ë°ì´í„°ì˜ ì •í•©ì„±ì´ ì¤‘ìš”í•˜ë©´(ëˆ,...) `ì°¸ì¡° ë¬´ê²°ì„±` ì œì•½ì¡°ê±´ì„ ë§Œì¡±í•˜ê¸° ìœ„í•´ì„œ ë°˜ë“œì‹œ ê±¸ì–´ì•¼ í•˜ê³ 
- ë‹¨ìˆœ ì„œë¹„ìŠ¤ê°€ ì˜ ëŒì•„ê°€ê¸°ë§Œì„ ìœ„í•œ ê±°ë¼ë©´ -> indexë§Œ ì˜ ê±¸ì–´ì¤˜ë„ ëœë‹¤.


## ê°’ ê°ì²´ ?
Address ê°™ì€ ê°’ ê°ì²´ëŠ” ê°’ì´ê¸° ë•Œë¬¸ì— ë³€ê²½ë˜ë©´ ì•ˆë˜ê³ , Immutableí•˜ê²Œ ì„¤ê³„ë˜ì•¼ í•œë‹¤. ìƒì„±ìì—ì„œë§Œ ë§Œë“¤ê³ , SetterëŠ” ì œê±°í•œë‹¤. 

## Getter, Setter
ë°ì´í„°ë¥¼ ì¡°íšŒí•  ì¼ì´ ë§ìŒ. GetterëŠ” ì—´ì–´ë‘ê³ , SetterëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ìª½ìœ¼ë¡œ ë¹¼ì•¼ í•œë‹¤.

## JPA spec
- jpaëŠ” reflectionì´ë‚˜ proxyë¥¼ ì´ìš©í•´ì„œ ê°ì²´ë¥¼ ìƒì„±í•˜ê¸° ë•Œë¬¸ì—, ê¸°ë³¸ìƒì„±ìê°€ ì—†ë‹¤ë©´ ë¹¨ê°„ì¤„ì´ ëœ¬ë‹¤.

## ì—”í‹°í‹° ì„¤ê³„ì‹œ ì£¼ì˜ì‚¬í•­

-   setterë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤. 
    ê°ì²´ì— ëŒ€í•œ ë³€ê²½ì‚¬í•­ì„ íŒŒì•…í•˜ê¸° ì–´ë µê³ , ìœ ì§€ë³´ìˆ˜í•˜ê¸° ë§¤ìš° í˜ë“¤ë‹¤.

-   ì—°ê´€ê´€ê³„ ì„¤ì •ì€ lazyë¡œ ì„¤ì •í•œë‹¤.

    -   EAGERëŠ” ì˜ˆì¸¡ì´ ì–´ë µê³ , ì–´ë–¤ SQLì´ ì‹¤í–‰ë˜ëŠ”ì§€ íŒŒì•…í•˜ê¸° í˜ë“¤ë‹¤, íŠ¹íˆ JPQL ì„ ì‹¤í–‰í•  ë•Œ N + 1 ë¬¸ì œê°€ ìì£¼ ë°œìƒí•œë‹¤. 

        >    order N: member 1 ê´€ê³„ì—ì„œ
        >   select o from order; ì´ ê²°ê³¼ 100ê°œì˜ order ê²°ê³¼ê°€ ìˆìœ¼ë©´, í•´ë‹¹ ê²°ê³¼ë§ˆë‹¤ memberë¥¼ ì¡°íšŒí•˜ëŠ” ì¿¼ë¦¬ê°€ 100ë²ˆ ë°œìƒí•œë‹¤. ì¦‰, orderì¡°íšŒ ì¿¼ë¦¬ 1 ë²ˆì— ë”°ë¥¸ 100ë²ˆ(N)ë²ˆì˜ ê²°ê³¼ ê°’ì— ëŒ€í•œ ì¿¼ë¦¬ê°€ ì¶”ê°€ë¡œ ë°œìƒí•œë‹¤. í•´ì„œ N+1 ë¬¸ì œ!!

    -   ì—°ê´€ëœ ì—”í‹°í‹°ë¥¼ ê°€ì ¸ì˜¤ê³  ì‹¶ìœ¼ë©´ fetch join, ì—”í‹°í‹° ê·¸ë˜í”„ë¡œ í•´ê²°í•œë‹¤.

-   ì»¬ë ‰ì…˜ ì´ˆê¸°í™”ëŠ” í•„ë“œì—ì„œ ì´ˆê¸°í™” í•œë‹¤. 
    -   í•˜ì´ë²„ë„¤ì´íŠ¸ëŠ” ì—”í‹°í‹°ë¥¼ ì˜ì†í™” í• ë•Œ, ì»¬ë ‰ì…˜ì„ ê°ì‹¸ì„œ í•˜ì´ë²„ë„¤ì´íŠ¸ê°€ ì œê³µí•˜ëŠ” ì»¬ë ‰ì…˜ìœ¼ë¡œ ì œê³µí•œë‹¤. ê·¸ë ‡ê¸° ë•Œë¬¸ì— ì»¬ë ‰ì…˜ì„ ë³€ê²½í•´ì„œ ì‚¬ìš©í•˜ê²Œ ë˜ë©´, í•˜ì´ë²„ë„¤ì´íŠ¸ê°€ ì›í•˜ëŠ” ë™ì‘ë˜ë¡œ ë˜ì§€ ì•Šì„ ê°€ëŠ¥ì„±ì´ ìˆë‹¤.

-   í…Œì´ë¸”,ì»¬ëŸ¼ëª… ìƒì„±ì „ëµ 
    -   ìŠ¤í”„ë§ ë¶€íŠ¸ë¥¼ ì‚¬ìš©í•˜ê²Œ ë˜ë©´ SpringPhsicalNamingStrategyë¡œ camelcase -> uderscore ë¡œ ë³€ê²½í•œë‹¤.

-   casecade = CasecadeType.ALLë¡œ ì„¤ì •
    -   orderì— ì—¬ëŸ¬ê°œì˜ orderItemsë¥¼ ë‹´ê³  ìˆë‹¤ë©´, casecade ì„¤ì •ì„ í•˜ì§€ ì•ŠëŠ”ë‹¤ë©´ orderItem1,2,3 ê°ê°ì„ persist()ë¡œ ì €ì¥í•˜ê³ , order ì—”í‹°í‹°ë„ persist()ë¥¼ í†µí•´ì„œ ì—”í‹°í‹°ë¥¼ ê°ê°ì„ ì €ì¥í•œë‹¤. 
    -   CasecadeType.ALLë¡œ í•˜ê²Œë˜ë©´, orderì—”í‹°í‹°ë§Œ ì €ì¥í•´ë„, orderItem1,2,3 ì—”í‹°í‹°ë¥¼ ì§ì ‘ ì €ì¥í•˜ì§€ ì•Šì•„ë„ ëœë‹¤.

-   ì—°ê´€ê´€ê³„ í¸ì˜ ë©”ì„œë“œ ì‘ì„±
    -   ê°ì²´ì—ì„œ ì„œë¡œ ì°¸ì¡°ë˜ëŠ” ìƒí™©ì„ í¸ì˜ ë©”ì„œë“œ í˜•íƒœë¡œ ë§Œë“ ë‹¤. 
    -   ì£¼ë¡œ ë¡œì§ìƒ ì»¨íŠ¸ë¡¤í•˜ëŠ” ì£¼ë„ê¶Œì„ ê°€ì§„ ì—”í‹°í‹° í´ë˜ìŠ¤ í•˜ìœ„ì— í¸ì˜ë©”ì„œë“œë¥¼ ë§Œë“ ë‹¤. 
    -   Member 1 : Order N ì¸ ìƒí™©ì—ì„œ Order ì—”í‹°í‹°ì—ì„œ setMemberë¥¼ í¸ì˜ ë©”ì„œë“œë¡œ ë§Œë“¤ê²Œ ë˜ë©´ ë‹¤ìŒê³¼ ê°™ë‹¤.

```java
public class Order {
    //..ìƒëµ..

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "member_id")
    private Member member;
    
    // ì—°ê´€ê´€ê³„ í¸ì˜ ë©”ì„œë“œ
    public void setMember(Member member){
        this.member = member;
        member.setOrder(this); // ë°˜ëŒ€í¸ë„ ì…‹íŒ…í•´ì¤€ë‹¤.
    }
}
```


## ê°œë°œí•˜ëŠ” ìˆœì„œ 

-   ì• í”Œë¦¬ì¼€ì´ì…˜ ìš”êµ¬ì‚¬í•­ ë¶„ì„ 
-   ì—”í‹°í‹°, ë„ë©”ì¸ ì„¤ê³„ 
-   ì—”í‹°í‹° ì½”ë“œ ì‘ì„± (domain)
-   ì• í”Œë¦¬ì¼€ì´ì…˜ ì•„í‚¤í…ì³ ì„ íƒ
    -   Layer ê³„ì¸µ vs Domain ê³„ì¸µ íŒ¨í‚¤ì§€ êµ¬ë¶„ 
    -   ì´ˆê¸°ì—ëŠ” Layer ê³„ì¸µ íŒ¨í‚¤ì§€êµ¬ë¶„, ì°¨ì¸° ì„œë¹„ìŠ¤ê°€ ë°©ëŒ€í•´ ì§€ë©´ -> Domain ë³„ íŒ¨í‚¤ì§€ë¡œ êµ¬ë¶„í•´ì•¼í•¨
-   í•´ë‹¹ ë„ë©”ì¸ì˜ ë ˆí¬ì§€í† ë¦¬ êµ¬í˜„  (Repository)
-   í•´ë‹¹ ë„ë©”ì¸ì˜ ì„œë¹„ìŠ¤ êµ¬í˜„ (Service)
-   í•´ë‹¹ ë„ë©˜ì¸ì˜ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ (TestCase)
-   web ê³„ì¸µ êµ¬í˜„ (Controller)
-   í•´ë‹¹ ë„ë©”ì¸ì˜ API ê°œë°œ 
-   advanced API ê°œë°œ (ê³ ê¸‰ê³¼ì •)
    -   







jpql

-   JPQLì€ SQLê³¼ ê±°ì˜ ë¹„ìŠ·, JPQLì„ SQLë¡œ ë°”ê¾¼ë‹¤. 
-   SQL ì´ í…Œì´ë¸”ì„ ê¸°ì¤€ìœ¼ë¡œ ì¡°íšŒí•˜ëŠ” ê±°ë©´, JPQLì€ ì—”í‹°í‹°ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì¡°íšŒí•œë‹¤.

persist

-   em.persist(member)ì˜ ì˜ë¯¸? 
    -   ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— memberì—”í‹°í‹°ë¥¼ ë„£ëŠ”ë‹¤.
    -   transctionì´ commit ë˜ëŠ” ì‹œì ì— DBì— insert ì¿¼ë¦¬ê°€ ë‚ ì•„ê°„ë‹¤.
    
    
## í…ŒìŠ¤íŠ¸
JPAì™€ ì—°ë™í•˜ëŠ” í†µí•©í…ŒìŠ¤íŠ¸ ì‘ì„±ì‹œ.... 
í…ŒìŠ¤íŠ¸ í´ë˜ìŠ¤ì— @Transactional (ìŠ¤í”„ë§) ì–´ë…¸í…Œì´ì…˜ì„ ë¶™ì´ë©´, ê¸°ë³¸ rollbackì„ trueë¡œ í•œë‹¤. ì´ ë§ì¸ì¦‰ìŠ¨, JPAì—ì„œ êµ³ì´ insert í•˜ëŠ” ì¿¼ë¦¬ë¥¼ ì§ì ‘ ë‚ ë¦´ í•„ìš”ê°€ ì—†ë‹¤.
ê·¸ë ‡ê¸° ë•Œë¬¸ì— SQLë¬¸ì„ ë³´ë©´, Insert ì¿¼ë¦¬ê°€ ì—†ê³ , select ì¿¼ë¦¬ë§Œ ì¡´ì¬í•œë‹¤.

ê·¸ë ‡ë‹¤ë©´ ì‹¤ì œ INSERT ì¿¼ë¦¬ê¹Œì§€ ì§ì ‘í™•ì¸ í•˜ê³  ì‹¶ë‹¤ë©´
1. ë©”ì„œë“œìœ„ì— @Rollback(false) ì˜µì…˜ì„ ì£¼ëŠ” ê²ƒ 
2. EntityManagerë¥¼ í†µí•´ì„œ ì—”í‹°í‹°ë¥¼ save í•œ í›„ì— em.flush()ë©”ì„œë“œë¥¼ ì§ì ‘ í˜¸ì¶œí•œë‹¤.

## ì‘ì§‘ë ¥ì€ ì–´ë–»ê²Œ ë†’ì´ë‚˜? 
Item í´ë˜ìŠ¤ë¥¼ ì‚´í´ë³´ë©´, ë³´í†µ ì¬ê³  ìˆ˜ëŸ‰ì„ ë„£ê³ , ë¹¼ëŠ”ì‹ì˜ ë™ì‘ì€ ItemService ì—ì„œ ìˆ˜ëŸ‰ì •ë³´ë“¤ì„ ê°€ì§€ê³  ì™€ì„œ, ê³„ì‚°í•˜ê³ , setStockQuantityë¥¼ í†µí•´ì„œ ë³€ê²½ëœ(ê³„ì‚°ëœ) ë°ì´í„° ê°’ì„ ì…‹íŒ…í•œë‹¤. 
ì´ë ‡ê²Œ í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì€ (í•´ë‹¹ ë°ì´í„°ë¥¼ ê°€ì§€ê³  ìˆëŠ” í´ë˜ìŠ¤) ë‚´ì—ì„œ ë™ì‘í•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤. 

> ğŸ¤” ê·¸ëŸ¬ë©´ Repository(infrastrcuture layer) ë¥¼ í†µí•´ì„œ DBì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ”ê±´ ì–´ë–»ê²Œ ì²˜ë¦¬í• ê¹Œ?

## ì—”í‹°í‹°í´ë˜ìŠ¤ì˜ ê¸°ë³¸ ìƒì„±ì AccessLevel ì„¤ì •í•˜ê¸°
```java
@NoArgsConstructor(access = AccessLevel.PROTECTED)
public class Order {

}
```
ì €ê²Œ ì˜ë¯¸í•˜ëŠ” ë°”? Order ì—”í‹°í‹°ì˜ ìƒì„±ë©”ì„œë“œ(createOrder)ë¥¼ ë§Œë“ ë‹¤. ì™¸ë¶€ì—ì„œ Order ê°ì²´ë¥¼ ë§Œë“¤ë•Œ, ìš°ë¦¬ê°€ ë§Œë“  ìƒì„±ë©”ì„œë“œë¥¼ ì‚¬ìš©í•˜ê¸°ë¥¼ ì›í•œë‹¤. ê·¸ë ‡ì§€ ì•Šê³  ëˆ„êµ°ê°€ `new Order()`ë¥¼ í†µí•´ì„œ setterë¥¼ í†µí•´ì„œ ë§Œë“ ë‹¤ë©´ 
ì—¬ê¸°ì €ê¸° ì½”ë“œì˜ ì¼ê´€ì„±ë„ ì—†ê³ , ìœ ì§€ë³´ìˆ˜í•˜ê¸° í˜ë“¤ë‹¤. ê·¸ëŸ¼ ê¸°ë³¸ ìƒì„±ìë¥¼ publicì´ ì•„ë‹Œ protected ë¡œ ì„¤ì •í•˜ê²Œ ë˜ë©´ JPA ìŠ¤í™ì—ì„œ í—ˆìš©í•´ì¤€ë‹¤. ë˜í•œ, OrderServiceì—ì„œ `new Order()`ë¥¼ ë§Œë“œëŠ” ìˆœê°„ ì»´íŒŒì¼ íƒ€ì„ì—
ì•Œë ¤ì¤€ë‹¤. 
```java
public class Order {
   
    protected Order(){
    }
}
``` 
ì € protected ë ˆë²¨ì˜ ê¸°ë³¸ ìƒì„±ìë¥¼ ë¡¬ë³µ ì–´ë…¸í…Œì´ì…˜ìœ¼ë¡œ ë˜‘ê°™ì´ ë§Œë“¤ ìˆ˜ ìˆë‹¤. `@NoArgsConstructor(access = AccessLevel.PROTECTED)` ì´ë ‡ê²Œ 